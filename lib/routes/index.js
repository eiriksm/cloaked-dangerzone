// Generated by CoffeeScript 1.9.0
(function() {
  var app, settings, users, _;

  app = require('../app');

  users = {};

  _ = require('underscore');

  settings = app.settings;

  module.exports = {
    user: function(req, res) {
      var c, octo, user;
      user = req.params.user;
      if (!app.users[user]) {
        res.sendStatus(404);
        return;
      }
      if (app.cache[user]) {
        c = app.cache[user].unix;
        if (c && c > (Date.now() - 60000)) {
          res.send(app.cache[user]);
          return;
        }
      }
      octo = require('tripping-octo-nemesis');
      return octo.init(app.users[user], false, function(err, _) {
        return octo.status(function(err, result) {
          var data;
          if (!err) {
            data = {
              status: result,
              updated: new Date(),
              unix: Date.now()
            };
            app.cache[user] = data;
            res.send(data);
            return;
          }
          return res.sendStatus(500, 'problems');
        });
      });
    },
    allusers: function(req, res) {
      if (app.users[req.user]) {
        return res.send([req.user]);
      } else {
        return res.sendStatus(404);
      }
    },
    unbook: function(req, res) {
      var id, octo, user;
      user = req.params.user;
      id = req.params.id;
      octo = require('tripping-octo-nemesis');
      return octo.init(users[user], false, function(err, _) {
        return octo.unbook(id, function(e, r) {
          delete app.cache[user];
          return res.json(r);
        });
      });
    },
    index: function(req, res) {
      return res.sendfile("static/dartangular/web/index.html");
    }
  };

}).call(this);
